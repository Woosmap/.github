name: Check Open API schema change notification
description: This is checking open Api specification generated by PR and one with already published on develop-api.woosmap.com and notify team via new issue and slack "channel"

runs:
  using: 'composite'

  steps:

    - name: Get PR number from commit
      id: get_pr
      shell: bash
      run: |
        echo "Attempting to get PR via commits/${GITHUB_SHA}/pulls"
        PR_JSON=$(curl -s -H "Authorization: Bearer ${{ env.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/pulls")

        PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')

        if [ -z "$PR_NUMBER" ]; then
          echo "❌ No PR found via commits API. Trying search API..."

          SEARCH_JSON=$(curl -s -H "Authorization: Bearer ${{ env.GITHUB_TOKEN }}" \
            "https://api.github.com/search/issues?q=repo:${{ github.repository }}+type:pr+is:merged+sha:${{ github.sha }}")

          PR_NUMBER=$(echo "$SEARCH_JSON" | jq -r '.items[0].number // empty')
        fi

        if [ -z "$PR_NUMBER" ]; then
          echo "❌ No PR found for this commit."
          echo "pr_found=false" >> $GITHUB_OUTPUT
        else
          echo "✅ PR found: $PR_NUMBER"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "pr_found=true" >> $GITHUB_OUTPUT
        fi

    - name: Check if "openapi-changed" label exists on PR
      if: steps.get_pr.outputs.pr_found == 'true'
      uses: actions/github-script@v6
      id: check_label
      with:
        github-token: ${{ env.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ env.PR_NUMBER }};
          const labelToCheck = "openapi-changed"; 

          const { data: labels } = await github.rest.issues.listLabelsOnIssue({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });

          const found = labels.some(label => label.name === labelToCheck);
          core.setOutput("label_exists", found);

      
        
    - name: Create issue in Woosmap/woosmap if schemas changed
      if: steps.check_label.outputs.label_exists == 'true' && env.GITHUB_TOKEN != ''
      uses: actions/github-script@v6
      with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            // 0) Grab the PR payload
            const publicOwner = context.repo.owner;
            const publicRepo  = context.repo.repo;
            const prNumber    = ${{ env.PR_NUMBER }};
            
            // 0.1) grab PR details
            const { data: pr } = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
              owner: publicOwner,
              repo: publicRepo,
              pull_number: prNumber
            });

            // 1) Prepare private target repo
            const targetOwner = 'Woosmap';
            const targetRepo  = 'woosmap';
            const issueTitle  = `${{ steps.set_product.outputs.product }} OpenAPI change: #${pr.number} - ${pr.title}`;
            const author      = pr.user.login;

            // 2) Dedup via listForRepo on the private repo
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: targetOwner,
              repo:  targetRepo,
              state: 'open',
              per_page: 10
            });
            if (openIssues.some(i => i.title === issueTitle)) {
              console.log(`Issue "${issueTitle}" already exists; skipping creation.`);
              return;
            }

            // 3) Fetch diff from the PUBLIC repo where this PR lives
            let diffText = '';
            try {
              const diffRes = await github.request(
                'GET /repos/{owner}/{repo}/pulls/{pull_number}',
                {
                  owner: publicOwner,
                  repo:  publicRepo,
                  pull_number: pr.number,
                  mediaType: { format: 'diff' }
                }
              );
              diffText = diffRes.data;
            } catch (err) {
              console.warn('Unable to fetch PR diff:', err.message);
            }

            // 4) Truncate or embed the diff
            let diffBlock = '';
            if (diffText) {
              const MAX_FULL = 2000;
              const MAX_SNIP = 500;
              if (diffText.length <= MAX_FULL) {
                diffBlock = '```diff\n' + diffText + '\n```';
              } else {
                const snippet = diffText.slice(0, MAX_SNIP) + '\n...';
                diffBlock = '```diff\n' + snippet + '\n```';
              }
            }

            // 5) Build the issue body with a checklist
            const bodyLines = [
              `Open API Schema file were updated in PR ${pr.html_url}.`,
              '',
              `> ${pr.title}`,
              '',
              diffBlock,
              '',
              '**Please update these dependent libraries/SDKs/Plugins:**',
              '- [ ] MapsJS',
              '- [ ] Native SDK',
              '- [ ] RN Plugin',
              '- [ ] Flutter Plugin'
            ].filter(Boolean);


            // 6) Create the issue in the PRIVATE repo, assigned to the PR author
            await github.rest.issues.create({
              owner:      targetOwner,
              repo:       targetRepo,
              title:      issueTitle,
              body:       bodyLines.join('\n'),
              assignees:  [author]
            });

    - name: Send Slack notification if schemas changed
      if: steps.check_label.outputs.label_exists == 'true' && env.WOOSMAP_SLACK_WEBHOOK != ''
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "channel": "#${{ env.WOOSMAP_SLACK_CHANNEL }}",
            "text": "🚨 OpenAPI schema has changed. Please refer to the PR <https://github.com/${{ github.repository }}/pull/${{ env.PR_NUMBER }}|#${{ env.PR_NUMBER }}> for more insights."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ env.WOOSMAP_SLACK_WEBHOOK }}
    
